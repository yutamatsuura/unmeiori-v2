# 運命織（unmeiori）開発ガイド

## 🎯 プロジェクト概要
**運命織（unmeiori）** - 九星気学・姓名判断・吉方位の統合鑑定書システム
- マイクロサービスアーキテクチャ
- 高精度な東洋占術の自動鑑定
- プロフェッショナル品質の鑑定書PDF出力

## 🏗️ 技術スタック

### フロントエンド
- **Framework**: React + Vite + TypeScript
- **UI**: Material-UI (MUI)
- **Port**: 3001 (固定)
- **Directory**: `/frontend`

### バックエンド・マイクロサービス
- **統合API**: FastAPI (Python) - Port 5004
- **九星気学サービス**: TypeScript/Express - Port 5002
- **姓名判断サービス**: TypeScript/Express - Port 5003
- **データベース**: PostgreSQL (Neon)

### ポート設定（絶対厳守）
```yaml
フロントエンド: 3001
九星気学サービス: 5002
姓名判断サービス: 5003
統合API (FastAPI): 5004
```

## 🌟 基本理念
「シンプルさは究極の洗練である」- レオナルド・ダ・ヴィンチ
「プロジェクトでいまここに不要なコードは一文字も残さない」
「最高の仕様書はドキュメントではなく美しく整ったアーキテクチャのコードそのものである」
「秩序を保つことに責任を持つ。整理整頓された綺麗な部屋のようにコードやドキュメントの片付け整理を忘れない」
「ジョブスのように誰もみてない細部のコードの美しさにも職人のようにこだわる」

## 🎯 5つの核心原則

### 1. 最小性の原則（Principle of Minimalism）
**「必要最小限を超えない」**
- 新規作成より既存活用を優先する
- 解決策は常に最もシンプルなものを選ぶ
- あったらいいなはないほうがいい

### 2. 単一性の原則（Principle of Singularity）
**「真実の源は常に一つ」**
- 型定義はschemas/index.tsに集約させる
- 実装計画はSCOPE_PROGRESS.mdに集約させる
- 仕様書やロジックなどはrequirements.mdに集約させる

### 3. 刹那性の原則（Principle of Ephemerality）
**「今、ここで必要なものだけを残す」**
- 役目を終えたものは即座に削除する
- 修正や変更により使わなくなったコードは即リファクタリング
- 後方互換の原則禁止(ただし修正時は安全を確保するよう慎重に)
- 未来の「もしかして」のために保持しない
- 生きているコードとドキュメントのみを維持する

### 4. 実証性の原則（Principle of Evidence）
**「事実こそが真実への唯一の道」**
- 環境変数やデータベースを積極的に確認する
- 開発環境でもバックエンドは全て本番のAPIを使って検証テスト作成する。バックエンドのモック絶対禁止
- デバッグで明確に原因がわからない場合はログを設置する。推測しない
- 外部APIや比較的新しい技術はweb検索を積極的に活用する。仕様を推測しない
- **Web検索前に必ず`date`コマンドで現在日時を確認し、現在の最新情報を検索する**

### 5. 潔癖性の原則（Principle of Fail-Fast）
**「失敗は隠すな、早く明確に、透明に失敗せよ」**
- エラーは即座に表面化させる
- フォールバックによる問題の隠蔽を禁止する
- そもそもフォールバック不要のシンプルで堅牢性の高い構造を作る

## 📁 ドキュメント管理の原則

単一の真実源の原則を守らせ、勝手なドキュメントを無作為に作らせないように制御してください。
- **docs/SCOPE_PROGRESS.md**: 今これからやるべき実装の計画
- **docs/requirements.md**: 今これからやるべき実装の詳細
- **docs/DEPLOYMENT.md**: デプロイ情報
- **docs/designsystem.md**: デザインシステム
- **docs/api-specs/[ページ名]-api.md**: API仕様書（@MOCK_TO_APIから自動生成）
- **docs/e2e-specs/[ページ名]-e2e.md**: E2Eテスト仕様書（Phase 7で自動生成）

例えばリサーチして何か知見があり、その結果としてドキュメント化したいのであれば
requirements.md(要件やロジック)
SCOPE_PROGRESS.md(実装計画)

こちらにのみ記載可能であり、こちらに記載する価値がなければ回答のみで報告してください。
これ以外のドキュメントはユーザーへの確認と明確な許諾がない限り作成してはいけません。

requirements.md(要件やロジック)
SCOPE_PROGRESS.md(実装計画)

こちらは実装が完了しコードに落とし込まれている記載は積極的に削除し不要な記載はなくす。

## 🔧 開発環境設定

### 6. 環境変数の絶対原則
- **開発中は全ての場面で.env.localのみ使用**
- テストスクリプトは必ず.env.localを読み込ませる
- .env.test、.env.developmentなど作らない
- DATABASE_URLは.env.localの1箇所のみ

### 7. データベースの絶対原則
- **PostgreSQL (Neon) 使用**
- 接続エラー時は環境変数エラーとして即報告
- **DBURLエラー時は環境変数エラーとして即報告**

### 8. テストも.env.localを使用
- テスト専用DBは作らない
- 同じDBで問題なし（開発段階）
- process.env.DATABASE_URLをそのまま使用

### 9. サーバー起動の絶対原則
- サーバーは1つ維持
- 再起動禁止（ホットリロードを使う）
- 既存サーバーがある場合はそれを使う
  （理由：複数エージェントで同プロジェクトを扱うため、既存サーバーのほとんどは同じプロジェクト。失敗時のみ調査し、違う場合のみ新規起動）

### 10. エラー時の絶対原則
- **環境変数エラー** → 全タスク強制終了し即座に報告（試行錯誤禁止）
- **データベース接続エラー** → 1回だけ再試行
- **3回同じエラー** → Web検索を許可

### 11. ローカル開発サーバーポート設定（絶対厳守）
**これ以外のポートでサーバー起動は絶対禁止**
- **フロントエンド（React）**: ポート3001のみ
  - 起動コマンド: `PORT=3001 npm start` (frontend directory)
- **九星気学サービス**: ポート5002のみ
  - 起動コマンド: `npm start` (services/kyusei-service directory)
- **姓名判断サービス**: ポート5003のみ
  - 起動コマンド: `npm start` (services/seimei-service directory)
- **統合API（FastAPI）**: ポート5004のみ
  - 起動コマンド: `uvicorn main:app --reload --port 5004`

**重要**:
- 複数のAIエージェントが勝手に別ポートでサーバー起動することを禁止
- 既存サーバーが稼働中の場合は必ずそれを使用
- ポート変更や重複起動は混乱の元となるため絶対に行わない
- サーバー起動前に必ず既存プロセスを確認すること

## 🧪 テスト設定

### E2Eテスト環境
- **ツール**: Playwright固定（Puppeteer等へのダウングレード禁止）
- **構造**:
  - `tests/e2e/` - テストファイル
  - `tests/screenshots/` - スクリーンショット（実行後削除）
  - `tests/temp/` - 一時ファイル（実行後削除）
- **認証**:
  - テストユーザー: test@example.com
  - テストパスワード: testpass123
  - 備考: 開発環境用のテストアカウント（本番では別途設定）

### 環境変数リスト（.env.local）
```env
# 基本設定
NODE_ENV=development

# URL設定（絶対にハードコード禁止）
FRONTEND_URL=http://localhost:3001
CORS_ORIGIN=http://localhost:3001

# マイクロサービス URL
KYUSEI_SERVICE_URL=http://localhost:5002
SEIMEI_SERVICE_URL=http://localhost:5003
MAIN_API_URL=http://localhost:5004

# フロントエンド用API設定
REACT_APP_API_URL=http://localhost:5004

# データベース
DATABASE_URL=[PostgreSQL接続文字列]

# 認証
JWT_SECRET=[32文字以上のランダム文字列]
SESSION_SECRET=[32文字以上のランダム文字列]
```

## 🔒 絶対禁止事項

### 固定値
- URL: 変更禁止
- ポート: この CLAUDE.md で定義済み
- 使用中エラー時: 既存プロセスを使う（新ポート起動禁止）

### バックエンドテストの鉄則
- **目的**: 本番環境での堅牢性向上（合格が目的ではない）
- **禁止**:
  - モックで誤魔化す
  - テストをコメントアウト
  - ダミーデータで回避
  - expect値を現状に合わせて変更
  - フォールバック実装（try-catchで握り潰す等）
  - 環境変数ハードコード（必ず.env.localから読込）
- **必須**: 実DBアクセス、実API通信、実認証、エラー即座表面化
- **環境変数**: require('dotenv').config({ path: '.env.local' })

## 📁 プロジェクト構造
```
unmeiori/
├── docs/                    # ドキュメント（これのみ）
│   ├── SCOPE_PROGRESS.md      # 実装計画
│   ├── DEPLOYMENT.md          # デプロイ手順
│   └── requirements.md       # 仕様・要件・ロジック
├── frontend/                # React + TypeScript フロントエンド
├── services/                # マイクロサービス
│   ├── kyusei-service/        # 九星気学サービス
│   └── seimei-service/        # 姓名判断サービス
├── tests/                   # テストコード
│   ├── e2e/                   # E2Eテスト
│   ├── screenshots/           # スクリーンショット（実行後削除）
│   └── temp/                  # 一時ファイル（実行後削除）
├── .env.local              # 環境変数（これのみ）
├── .gitignore              # Git除外設定
├── README.md               # プロジェクト概要のみ
└── CLAUDE.md               # このファイル
```

## 🆕 最新技術情報（知識カットオフ対応）
- [要検証] React 18+ の新機能への対応状況
- [要検証] FastAPI の最新バージョンとの互換性
- [要検証] TypeScript 5.x での型定義変更点

---

**動いているものを壊すより、動かないものを作る方がマシ**