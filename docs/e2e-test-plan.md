# sindankantei E2Eテスト計画書

## 📊 プロジェクト概要

**プロジェクト名**: sindankantei（鑑定書楽々作成ツール）
**作成日**: 2025-09-23
**対象システム**: 九星気学・姓名判断の統合鑑定書システム
**テスト環境**: マイクロサービスアーキテクチャ

## 🎯 テスト目標

### 主要目標
1. **機能完全性の検証**: 全ページの基本機能が正常動作すること
2. **気学なびAPI完全一致検証**: 姓名判断結果が https://kigaku-navi.com/qsei/seimei.php と同一結果になること
3. **システム統合性の検証**: マイクロサービス間の連携が正常動作すること
4. **データ整合性の検証**: 九星気学・姓名判断の計算精度が100%であること
5. **ユーザーエクスペリエンス検証**: 実際の鑑定士が使用できる品質であること

### 品質基準
- **機能テスト**: 通過率100%（全テスト項目クリア必須）
- **パフォーマンス**: 鑑定計算3秒以内、PDF生成30秒以内
- **データ精度**: 気学なびAPIと100%同一結果（画数・スコア・コメント）
- **UI/UX**: モバイル・タブレット・デスクトップ完全対応

## 🏗️ テスト対象システム構成

### アーキテクチャ
```
Frontend (React:3001) → 統合API (FastAPI:5004)
                         ├── 九星気学サービス (TypeScript:5002)
                         ├── 姓名判断サービス (TypeScript:5003)
                         └── 気学なびAPI (外部)
```

### テスト対象ページ
- **P-001**: ログインページ (`/login`)
- **P-002**: 鑑定書作成ページ (`/create`)
- **P-003**: 鑑定書プレビュー・送信ページ (`/preview/:id`)
- **P-004**: 鑑定履歴管理ページ (`/history`)
- **P-005**: テンプレート設定ページ (`/settings`)

## 📋 テスト項目分類

### A. 正常系テスト（基本機能）
### B. 異常系テスト（エラーハンドリング）
### C. 気学なびAPI検証テスト（完全一致）
### D. パフォーマンステスト
### E. レスポンシブテスト
### F. セキュリティテスト

---

## 🔐 A. 正常系テスト（基本機能）

### A-001: ログインページテスト

| テストID | テスト項目 | 操作手順 | 期待結果 |
|---------|------------|---------|----------|
| A-001-01 | 正常ログイン | 1. `/login`アクセス<br>2. メール:`test@example.com` パスワード:`testpass123`入力<br>3. ログインボタンクリック | `/create`にリダイレクトし、ヘッダーにログアウトボタン表示 |
| A-001-02 | 自動リダイレクト | 1. 認証済み状態で`/login`アクセス | `/create`に自動リダイレクト |
| A-001-03 | セッション管理 | 1. ログイン後、ブラウザリロード | ログイン状態維持、`/create`ページ表示 |

### A-002: 鑑定書作成ページテスト

| テストID | テスト項目 | 操作手順 | 期待結果 |
|---------|------------|---------|----------|
| A-002-01 | 基本入力・計算実行 | 1. 氏名:`田中太郎`<br>2. 生年月日:`1990-05-15`<br>3. 性別:`男性`<br>4. メール:`client@example.com`<br>5. 鑑定計算実行ボタンクリック | 計算成功メッセージ表示、プレビューセクションに結果表示 |
| A-002-02 | 姓名判断結果表示 | A-002-01実行後 | 総格・天格・地格・人格の画数表示、gogyou_balance・youin_pattern表示 |
| A-002-03 | 九星気学結果表示 | A-002-01実行後（九星気学対応時） | 本命星・月命星・日命星・五行表示 |
| A-002-04 | 詳細アコーディオン | プレビュー結果表示後、各アコーディオンクリック | 文字別詳細解説・陰陽配列解説・五行バランス解説・各格詳細解説が展開 |
| A-002-05 | プレビューボタン | 計算完了後、詳細プレビューボタンクリック | `/preview/temp`ページに遷移、計算結果データ持参 |

### A-003: 鑑定書プレビュー・送信ページテスト

| テストID | テスト項目 | 操作手順 | 期待結果 |
|---------|------------|---------|----------|
| A-003-01 | プレビュー表示 | A-002-05からの遷移 | クライアント情報と計算結果の詳細表示 |
| A-003-02 | PDF生成機能 | プレビューページでPDF生成ボタンクリック | PDF鑑定書生成、ダウンロード可能 |
| A-003-03 | メール送信機能 | 1. 送信先メール入力<br>2. メッセージ入力<br>3. 送信ボタンクリック | メール送信成功、送信完了メッセージ表示 |

### A-004: 鑑定履歴管理ページテスト

| テストID | テスト項目 | 操作手順 | 期待結果 |
|---------|------------|---------|----------|
| A-004-01 | 履歴一覧表示 | `/history`ページアクセス | 鑑定履歴の時系列表示（最新順） |
| A-004-02 | 詳細表示 | 履歴項目をクリック | 鑑定詳細情報表示 |
| A-004-03 | PDF再ダウンロード | 履歴詳細からPDF再ダウンロード | 過去のPDF鑑定書再取得 |
| A-004-04 | 再送信機能 | 履歴詳細から再送信ボタン | メール再送信フォーム表示・実行 |

### A-005: テンプレート設定ページテスト

| テストID | テスト項目 | 操作手順 | 期待結果 |
|---------|------------|---------|----------|
| A-005-01 | 設定ページ表示 | `/settings`ページアクセス | 現在の設定内容表示 |
| A-005-02 | ロゴアップロード | ロゴ画像（JPG/PNG、2MB以下）アップロード | アップロード成功、プレビュー表示 |
| A-005-03 | 基本情報設定 | 屋号・事業者名入力・保存 | 設定保存成功、確認メッセージ表示 |
| A-005-04 | デザインカスタマイズ | 色・フォント設定変更・保存 | 設定反映、リアルタイムプレビュー更新 |

---

## ⚠️ B. 異常系テスト（エラーハンドリング）

### B-001: フォームバリデーションテスト

| テストID | テスト項目 | 操作手順 | 期待結果 |
|---------|------------|---------|----------|
| B-001-01 | 必須項目未入力 | 氏名空白で鑑定実行 | エラーメッセージ「氏名を入力してください」表示、実行不可 |
| B-001-02 | 無効メールアドレス | メール:`invalid-email`で実行 | エラーメッセージ「有効なメールアドレスを入力してください」 |
| B-001-03 | 未来日付入力 | 生年月日に未来日付入力 | エラーメッセージ「正しい生年月日を入力してください」 |
| B-001-04 | 特殊文字名前 | 氏名:`！@#$%`で実行 | エラーハンドリングされ、フォールバック処理実行 |

### B-002: ネットワークエラーテスト

| テストID | テスト項目 | 操作手順 | 期待結果 |
|---------|------------|---------|----------|
| B-002-01 | API接続エラー | サービス停止状態で鑑定実行 | 「サーバーに接続できません」エラーメッセージ、再試行推奨 |
| B-002-02 | タイムアウトエラー | ネットワーク遅延時の鑑定実行 | タイムアウト検出、適切なエラーメッセージ表示 |
| B-002-03 | 部分サービス障害 | 姓名判断サービスのみ停止状態 | エラー内容明示、利用可能な機能のみ表示 |

### B-003: 認証エラーテスト

| テストID | テスト項目 | 操作手順 | 期待結果 |
|---------|------------|---------|----------|
| B-003-01 | 未認証アクセス | 未ログイン状態で`/create`アクセス | `/login`にリダイレクト |
| B-003-02 | セッション期限切れ | 長時間放置後の操作 | セッション期限切れ検出、再ログイン要求 |
| B-003-03 | 不正認証情報 | 無効なJWTトークン使用 | 認証エラー、ログインページリダイレクト |

---

## 🎯 C. 気学なびAPI検証テスト（完全一致）

### C-000: 実装ロジック比較基準

**基準実装ディレクトリ**: `./seimeihandan`
**現行実装ディレクトリ**: `./services/seimei-service`

#### ロジック比較マッピング

| 機能 | 基準実装（seimeihandan） | 現行実装（seimei-service） | 検証項目 |
|------|----------------------|------------------------|----------|
| 文字データ構造 | `src/js/seimeis/units/Chara.ts` | `src/seimeis/units/Chara.ts` | 画数・五行・陰陽の一致 |
| 姓名データ構造 | `src/js/seimeis/units/Seimei.ts` | `src/seimeis/units/Seimei.ts` | 姓・名の分離ロジック |
| 画数鑑定ロジック | `src/js/seimeis/kantei/kakusus/KakusuKantei.ts` | `src/kantei/kakusus/*.ts` | 天格・人格・地格・総格・外格計算 |
| 五行判定ロジック | `src/js/seimeis/kantei/gogyous/` | `src/kantei/gogyous/GogyouKantei.ts` | 五行バランス・相生相克判定 |
| 陰陽判定ロジック | `src/js/seimeis/kantei/youins/` | `src/kantei/youins/YouinKantei.ts` | 陰陽パターン・配列判定 |
| API統合サービス | `src/js/seimei.js` | `src/services/seimei-analysis-service.ts` | 外部API連携・結果統合 |

#### C-000-01: ロジック整合性事前確認

| テストID | 検証対象 | 基準ファイル | 現行ファイル | 期待結果 |
|---------|---------|------------|------------|----------|
| C-000-01-01 | 画数計算アルゴリズム | `seimeihandan/src/js/seimeis/kantei/kakusus/KakusuKantei.ts` | `seimei-service/src/kantei/kakusus/*.ts` | 計算ロジック完全同一 |
| C-000-01-02 | 五行判定ロジック | `seimeihandan/src/js/seimeis/kantei/gogyous/` | `seimei-service/src/kantei/gogyous/` | 判定結果完全同一 |
| C-000-01-03 | 陰陽パターン判定 | `seimeihandan/src/js/seimeis/kantei/youins/` | `seimei-service/src/kantei/youins/` | パターン評価完全同一 |
| C-000-01-04 | 文字データ取得 | `seimeihandan/` の文字データ取得ロジック | `seimei-service/src/external/kigaku-navi-client.ts` | 取得データ構造同一 |

#### C-000-02: コアクラス比較検証

```typescript
// 基準: seimeihandan/src/js/seimeis/units/Chara.ts
export default class Chara {
    private _name: string;
    private _kakusu: number;
    private _kana: string;
    private _gogyou: Gogyou;
    private _youin: YouIn;
    private _isBunri: boolean;
}

// 現行: seimei-service/src/seimeis/units/Chara.ts
// → 同一インターフェース・同一プロパティ・同一メソッドであることを確認
```

| テストID | テスト項目 | 検証内容 |
|---------|------------|----------|
| C-000-02-01 | Charaクラス互換性 | プロパティ・メソッドの完全一致 |
| C-000-02-02 | Seimeiクラス互換性 | 姓名分離・統合ロジックの一致 |
| C-000-02-03 | Kakuクラス互換性 | 画数計算・格取得ロジックの一致 |
| C-000-02-04 | Kanteiクラス互換性 | 鑑定実行・結果生成ロジックの一致 |

### C-001: 基準データ「松浦仁」での完全一致検証

| テストID | テスト項目 | 操作手順 | 期待結果（気学なび＋基準実装同一） |
|---------|------------|---------|----------|
| C-001-01 | 画数計算一致 | 氏名:`松浦仁`で鑑定実行 | 天格:`18`画、人格:`14`画、地格:`4`画、総格:`22`画、外格:`8`画 |
| C-001-02 | スコア一致 | 同上 | 総合スコア:`5`点/100点満点 |
| C-001-03 | 陰陽配列一致 | 同上 | 陰陽パターン:`●●●`、判定:`黒の方寄り` |
| C-001-04 | 五行バランス一致 | 同上 | `五行のバランス(悪)`、人格:`水-金` |
| C-001-05 | コメント一致 | 同上 | `コメントが付く項目が多いので、苦労の人生になることが多いです...` |
| C-001-06 | 詳細コメント一致 | 同上 | 各文字の詳細説明が気学なび・基準実装両方と完全一致 |

### C-002: 複数名前での一致検証

| テストID | テスト項目 | テスト対象名 | 検証項目 |
|---------|------------|-------------|----------|
| C-002-01 | 田中太郎 | `田中太郎` | 画数・スコア・陰陽・五行・コメントの完全一致 |
| C-002-02 | 佐藤花子 | `佐藤花子` | 画数・スコア・陰陽・五行・コメントの完全一致 |
| C-002-03 | 山田一郎 | `山田一郎` | 画数・スコア・陰陽・五行・コメントの完全一致 |
| C-002-04 | 鈴木美咲 | `鈴木美咲` | 画数・スコア・陰陽・五行・コメントの完全一致 |
| C-002-05 | 高橋健太 | `高橋健太` | 画数・スコア・陰陽・五行・コメントの完全一致 |

### C-003: 差分検出・レポートテスト

| テストID | テスト項目 | 操作手順 | 期待結果 |
|---------|------------|---------|----------|
| C-003-01 | 差分自動検出 | 各テストで気学なび・基準実装と結果比較 | 差分ある場合は詳細レポート出力 |
| C-003-02 | 差分レポート生成 | 全名前テスト完了後 | 不一致項目の詳細レポート生成 |
| C-003-03 | 一致率計算 | 同上 | 全体一致率（目標95%以上）算出 |
| C-003-04 | 基準実装との一致確認 | seimeihandanディレクトリの実装と比較 | ロジック・データ構造の完全一致確認 |

### C-004: 実装品質向上テスト

#### C-004-01: コードレベル検証
```bash
# 基準実装と現行実装の比較検証コマンド例
diff -r ./seimeihandan/src/js/seimeis/units/ \
        ./services/seimei-service/src/seimeis/units/

# 特定ファイルの詳細比較
diff ./seimeihandan/src/js/seimeis/units/Chara.ts \
     ./services/seimei-service/src/seimeis/units/Chara.ts
```

| テストID | 検証項目 | 基準パス | 現行パス | 検証内容 |
|---------|---------|---------|---------|----------|
| C-004-01-01 | 文字クラス構造 | `seimeihandan/src/js/seimeis/units/Chara.ts` | `seimei-service/src/seimeis/units/Chara.ts` | プロパティ・メソッドの同一性 |
| C-004-01-02 | 姓名クラス構造 | `seimeihandan/src/js/seimeis/units/Seimei.ts` | `seimei-service/src/seimeis/units/Seimei.ts` | データ処理ロジックの同一性 |
| C-004-01-03 | 画数鑑定ロジック | `seimeihandan/src/js/seimeis/kantei/kakusus/` | `seimei-service/src/kantei/kakusus/` | 計算アルゴリズムの同一性 |
| C-004-01-04 | 五行判定ロジック | `seimeihandan/src/js/seimeis/kantei/gogyous/` | `seimei-service/src/kantei/gogyous/` | 判定ロジックの同一性 |

#### C-004-02: データ整合性検証

| テストID | テスト項目 | 基準データ | 現行データ | 検証方法 |
|---------|------------|------------|------------|----------|
| C-004-02-01 | 文字画数データ | seimeihandan内の画数マスター | seimei-service内の画数データ | 全文字の画数値一致確認 |
| C-004-02-02 | 五行データ | seimeihandan内の五行マスター | seimei-service内の五行データ | 全文字の五行値一致確認 |
| C-004-02-03 | 陰陽データ | seimeihandan内の陰陽マスター | seimei-service内の陰陽データ | 全文字の陰陽値一致確認 |
| C-004-02-04 | 鑑定メッセージ | seimeihandan内のメッセージDB | seimei-service内のメッセージデータ | 全メッセージの内容一致確認 |

---

## ⚡ D. パフォーマンステスト

### D-001: 応答速度テスト

| テストID | テスト項目 | 測定対象 | 性能基準 |
|---------|------------|---------|----------|
| D-001-01 | ページ読み込み速度 | 各ページの初期表示時間 | 2秒以内 |
| D-001-02 | 鑑定計算速度 | 鑑定計算実行〜結果表示 | 3秒以内 |
| D-001-03 | PDF生成速度 | PDF生成実行〜ダウンロード可能 | 30秒以内 |
| D-001-04 | API応答速度 | 各マイクロサービスの応答時間 | 500ms以内 |

### D-002: 負荷テスト

| テストID | テスト項目 | テスト条件 | 期待結果 |
|---------|------------|---------|----------|
| D-002-01 | 同時ユーザーテスト | 10ユーザー同時鑑定実行 | 全ユーザー正常完了、レスポンス時間基準内 |
| D-002-02 | 連続処理テスト | 1ユーザーが連続20回鑑定実行 | 全処理正常完了、メモリリーク無し |
| D-002-03 | 大量データテスト | 履歴1000件蓄積状態でのページ表示 | 表示速度基準内、ページネーション正常動作 |

---

## 📱 E. レスポンシブテスト

### E-001: デバイス別表示テスト

| テストID | デバイス | 解像度 | テスト項目 |
|---------|---------|--------|----------|
| E-001-01 | Desktop | 1920×1080 | 全ページレイアウト正常、操作性良好 |
| E-001-02 | Tablet | 768×1024 | レスポンシブデザイン適用、タッチ操作対応 |
| E-001-03 | Mobile | 375×667 | モバイル最適化、縦スクロール対応 |
| E-001-04 | Large Desktop | 2560×1440 | 高解像度対応、コンテンツ適切配置 |

### E-002: ブラウザ互換性テスト

| テストID | ブラウザ | バージョン | テスト結果 |
|---------|---------|-----------|----------|
| E-002-01 | Chrome | Latest | 全機能正常動作 |
| E-002-02 | Firefox | Latest | 全機能正常動作 |
| E-002-03 | Safari | Latest | 全機能正常動作 |
| E-002-04 | Edge | Latest | 全機能正常動作 |

---

## 🔒 F. セキュリティテスト

### F-001: 認証・認可テスト

| テストID | テスト項目 | テスト方法 | 期待結果 |
|---------|------------|---------|----------|
| F-001-01 | SQLインジェクション対策 | 入力フィールドに不正SQL挿入 | 攻撃無効化、正常エラーハンドリング |
| F-001-02 | XSS対策 | 入力フィールドにスクリプトタグ挿入 | スクリプト実行されない、サニタイズ処理 |
| F-001-03 | CSRF対策 | 外部サイトからの不正リクエスト | リクエスト拒否、CSRFトークン検証 |
| F-001-04 | セッション管理 | セッション固定・ハイジャック試行 | セッション適切保護、不正アクセス防止 |

### F-002: データ保護テスト

| テストID | テスト項目 | テスト方法 | 期待結果 |
|---------|------------|---------|----------|
| F-002-01 | 個人情報保護 | 通信暗号化確認 | HTTPS通信、TLS1.2以上使用 |
| F-002-02 | パスワード保護 | パスワードハッシュ化確認 | 平文保存無し、適切ハッシュ化 |
| F-002-03 | ログ出力制限 | ログファイル確認 | 個人情報ログ出力無し |

---

## 🛠️ テスト実行環境

### 必要ソフトウェア
```yaml
Node.js: 20.x LTS
Python: 3.11+
Playwright: Latest
PostgreSQL: 15+
Redis: 7+
Docker: Latest (Optional)
```

### 環境変数設定（.env.local）
```bash
# フロントエンド設定
REACT_APP_API_URL=http://localhost:5004

# サービス URL設定
KYUSEI_SERVICE_URL=http://localhost:5002
SEIMEI_SERVICE_URL=http://localhost:5003
MAIN_API_URL=http://localhost:5004

# データベース
DATABASE_URL=[PostgreSQL接続文字列]

# 認証
JWT_SECRET=[32文字以上のランダム文字列]
SESSION_SECRET=[32文字以上のランダム文字列]
```

### テスト実行手順
```bash
# 1. 全サービス起動
npm run start:all  # 全マイクロサービス起動

# 2. フロントエンド起動
cd frontend && PORT=3001 npm start

# 3. 基準実装との比較検証
npm run test:seimeihandan-comparison

# 4. E2Eテスト実行
npm run test:e2e

# 5. パフォーマンステスト実行
npm run test:performance

# 6. 気学なび検証テスト実行（基準実装併用）
npm run test:kigaku-navi-validation

# 7. 実装品質検証（コードレベル）
npm run test:implementation-quality
```

### 追加検証スクリプト
```bash
# seimeihandan との実装比較スクリプト
#!/bin/bash
echo "=== seimeihandan 実装比較検証 ==="

# 1. ディレクトリ構造比較
echo "ディレクトリ構造比較:"
diff -qr ./seimeihandan/src/js/seimeis/ \
         ./services/seimei-service/src/seimeis/ || true

# 2. 重要ファイルの詳細比較
echo "コアクラス比較:"
FILES=(
    "units/Chara.ts"
    "units/Seimei.ts"
    "kantei/Kantei.ts"
    "kantei/kakusus/KakusuKantei.ts"
)

for file in "${FILES[@]}"; do
    echo "比較中: $file"
    diff "./seimeihandan/src/js/seimeis/$file" \
         "./services/seimei-service/src/seimeis/$file" || true
    echo "---"
done

# 3. テストデータでの結果比較
echo "テストデータ比較実行:"
npm run test:data-consistency
```

## 📊 テスト結果記録

### テスト実行記録テンプレート
```markdown
## テスト実行結果 - [実行日]

### 環境情報
- OS: [OS名・バージョン]
- ブラウザ: [ブラウザ名・バージョン]
- Node.js: [バージョン]
- 実行者: [実行者名]

### 結果サマリー
- 総テスト項目数: [数]項目
- 成功: [数]項目
- 失敗: [数]項目
- 成功率: [%]

### 気学なび一致検証結果
- 画数一致率: [%]
- スコア一致率: [%]
- コメント一致率: [%]
- 総合一致率: [%]

### 基準実装（seimeihandan）一致検証結果
- コアクラス構造一致率: [%]
- データ構造一致率: [%]
- 計算ロジック一致率: [%]
- 統合ロジック一致率: [%]

### 失敗項目詳細
[失敗項目の詳細記録]

### パフォーマンス結果
- 平均鑑定時間: [秒]
- 最大応答時間: [秒]
- PDF生成時間: [秒]
```

## 🚨 クリティカル失敗基準

以下の項目で失敗した場合は**リリース不可**
1. **気学なびAPI一致率が95%未満**
2. **鑑定計算で明らかに間違った結果が出力**
3. **個人情報の漏洩・不正アクセス可能**
4. **基本認証機能の不具合**
5. **PDF生成の完全失敗**

## 📈 継続的改善項目

1. **テスト自動化**: CI/CDパイプラインでの自動実行
2. **監視強化**: 本番環境での継続的品質監視
3. **ユーザビリティ**: 実鑑定士によるユーザビリティテスト
4. **拡張性**: 新機能追加時のテストカバレッジ維持

---

**作成者**: BlueLamp PageOrchestrater
**最終更新**: 2025-09-23
**次回レビュー**: テスト実行完了後